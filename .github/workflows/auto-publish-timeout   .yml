name: Auto-Publish Blog Post (Timeout)

on:
  schedule:
    # Every day at 10:00 AM Mountain Time (17:00 UTC)
    - cron: "0 17 * * *"
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  auto-publish:
    runs-on: ubuntu-latest
    env:
      TZ: America/Denver

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Find open image selection issues
        id: find_issues
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'select-cover-image'
            });

            // Filter issues older than 24 hours
            const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
            const oldIssues = issues.filter(issue => {
              return new Date(issue.created_at) < oneDayAgo;
            });

            if (oldIssues.length === 0) {
              core.info('No issues older than 24 hours found');
              return null;
            }

            const issue = oldIssues[0]; // Process first old issue
            core.setOutput('issue_number', issue.number);
            core.setOutput('issue_body', issue.body);
            core.setOutput('issue_title', issue.title);
            return issue.number;

      - name: Auto-select random image
        if: steps.find_issues.outputs.issue_number
        id: select
        run: |
          # Generate random number between 1-5
          IMAGE_NUM=$((1 + RANDOM % 5))
          echo "image_number=$IMAGE_NUM" >> $GITHUB_OUTPUT
          echo "üé≤ Auto-selected random image: #$IMAGE_NUM"

      - name: Download selected image
        if: steps.find_issues.outputs.issue_number
        id: download
        env:
          IMAGE_NUM: ${{ steps.select.outputs.image_number }}
          ISSUE_BODY: ${{ steps.find_issues.outputs.issue_body }}
        run: |
          # Get image URL from issue body
          IMAGE_URL=$(echo "$ISSUE_BODY" | grep -A1 "Image $IMAGE_NUM:" | grep "Download:" | sed 's/.*Download: //' | sed 's/).*//')

          if [ -z "$IMAGE_URL" ]; then
            echo "‚ùå Could not find image URL"
            exit 1
          fi

          echo "Downloading: $IMAGE_URL"

          # Download image
          curl -L "$IMAGE_URL" -o blog/cover-temp.jpg

          # Get post filename from issue
          POST_FILE=$(echo "$ISSUE_BODY" | grep "Post file:" | sed 's/.*`\(.*\)`.*/\1/')
          echo "post_file=$POST_FILE" >> $GITHUB_OUTPUT

          # Get attribution from issue
          PHOTOGRAPHER=$(echo "$ISSUE_BODY" | grep -A1 "Image $IMAGE_NUM:" | grep "by" | sed 's/.*by \(.*\) on.*/\1/')
          UNSPLASH_URL=$(echo "$ISSUE_BODY" | grep -A1 "Image $IMAGE_NUM:" | grep "Unsplash" | sed 's/.*(\(.*\)).*/\1/')

          echo "photographer=$PHOTOGRAPHER" >> $GITHUB_OUTPUT
          echo "unsplash_url=$UNSPLASH_URL" >> $GITHUB_OUTPUT

      - name: Get PR branch
        if: steps.find_issues.outputs.issue_number
        id: pr_info
        env:
          ISSUE_BODY: ${{ steps.find_issues.outputs.issue_body }}
        run: |
          # Get PR number from issue
          PR_NUM=$(echo "$ISSUE_BODY" | grep "PR #" | sed 's/.*PR #\([0-9]*\).*/\1/')
          echo "pr_number=$PR_NUM" >> $GITHUB_OUTPUT

          # Get PR branch name
          BRANCH_NAME=$(gh pr view "$PR_NUM" --json headRefName -q .headRefName)
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout PR branch
        if: steps.find_issues.outputs.issue_number
        run: |
          git fetch origin ${{ steps.pr_info.outputs.branch_name }}
          git checkout ${{ steps.pr_info.outputs.branch_name }}

      - name: Add image to blog post
        if: steps.find_issues.outputs.issue_number
        run: |
          POST_FILE="${{ steps.download.outputs.post_file }}"
          PHOTOGRAPHER="${{ steps.download.outputs.photographer }}"
          UNSPLASH_URL="${{ steps.download.outputs.unsplash_url }}"

          # Move cover image to final location
          POST_SLUG=$(basename "$POST_FILE" .html)
          mv blog/cover-temp.jpg "blog/posts/images/${POST_SLUG}-cover.jpg"

          # Insert cover image HTML after post header
          sed -i '/<div class="post-content">/i \
      <div style="margin-bottom: 40px;">\
        <img src="images/'"${POST_SLUG}"'-cover.jpg" alt="Cover image" style="width: 100%; max-height: 400px; object-fit: cover; border-radius: 24px;">\
        <p style="text-align: center; font-size: 0.85rem; color: var(--muted); margin-top: 8px;">Photo by <a href="'"${UNSPLASH_URL}"'" style="color: var(--periwinkle);">'"${PHOTOGRAPHER}"'</a> on Unsplash</p>\
      </div>' "$POST_FILE"

          echo "‚úÖ Cover image added to $POST_FILE"

      - name: Commit and merge
        if: steps.find_issues.outputs.issue_number
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .
          git commit -m "Auto-publish: Add random cover image (timeout)"
          git push

          # Merge PR
          gh pr merge "${{ steps.pr_info.outputs.pr_number }}" --squash --auto
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Close issue with timeout message
        if: steps.find_issues.outputs.issue_number
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.find_issues.outputs.issue_number }},
              state: 'closed'
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.find_issues.outputs.issue_number }},
              body: '‚è∞ **Auto-Published (Timeout)**\n\nNo image selection received within 24 hours.\n\nRandomly selected image #${{ steps.select.outputs.image_number }} and published your blog post! üéâ\n\nYour blog post is now live at: https://jadenschwartz22-ops.github.io/sleepmedic-blog/blog/'
            });
