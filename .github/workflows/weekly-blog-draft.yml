name: Weekly SleepMedic Blog Draft

on:
  schedule:
    # Every Monday at 9:00 AM Mountain Time (16:00 UTC)
    - cron: "0 16 * * 1"
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  generate-draft:
    runs-on: ubuntu-latest
    env:
      TZ: America/Denver
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      OPENAI_MODEL: gpt-4o-mini

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Generate blog post
        id: generate
        run: |
          node scripts/generate-blog-post.mjs

          jq -r '.title' tmp/post-metadata.json | xargs -I {} echo "title={}" >> $GITHUB_OUTPUT
          jq -r '.filename' tmp/post-metadata.json | xargs -I {} echo "filename={}" >> $GITHUB_OUTPUT
          jq -r '.topic' tmp/post-metadata.json | xargs -I {} echo "topic={}" >> $GITHUB_OUTPUT
          jq -r '.tag' tmp/post-metadata.json | xargs -I {} echo "tag={}" >> $GITHUB_OUTPUT
          jq -r '.excerpt' tmp/post-metadata.json | xargs -I {} echo "excerpt={}" >> $GITHUB_OUTPUT
          jq -r '.imageIdea' tmp/post-metadata.json | tr '\n' ' ' | xargs -I {} echo "image_idea={}" >> $GITHUB_OUTPUT

      - name: Generate RSS feed
        run: node scripts/generate-rss-feed.mjs

      - name: Fetch Unsplash images
        id: images
        env:
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
          IMAGE_IDEA: ${{ steps.generate.outputs.image_idea }}
        run: node scripts/fetch-unsplash-images.mjs

      - name: Create Pull Request
        id: pr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "blog: Add ${{ steps.generate.outputs.filename }}"
          title: "üìù Blog Draft: ${{ steps.generate.outputs.title }}"
          body: |
            ## ü§ñ Auto-Generated Blog Post

            **Topic:** ${{ steps.generate.outputs.topic }}
            **Tag:** ${{ steps.generate.outputs.tag }}
            **Title:** ${{ steps.generate.outputs.title }}
            **File:** `blog/posts/${{ steps.generate.outputs.filename }}`

            **Cover Image Idea:** ${{ steps.generate.outputs.image_idea }}

            ---

            ### ‚úÖ Review Checklist

            Please review before merging:

            - [ ] **Factual Accuracy** - Verify all sleep science information is correct
            - [ ] **Citations Verify** - Check links to CDC, NIH, AASM, NAMS, etc.
            - [ ] **Tone & Voice** - Matches SleepMedic style (warm, direct, science-forward)
            - [ ] **Links Work** - All inline links resolve correctly
            - [ ] **SEO** - Title, excerpt, and keywords are optimized
            - [ ] **Mobile** - Test responsiveness on mobile device
            - [ ] **Shift Worker Relevance** - Content is practical for target audience

            ---

            ### üìù Notes

            - **Merge within 7 days** to keep content timely
            - **Edit directly in PR** if changes needed (edit files in PR, not branch)
            - **Auto-deploys** to sleepmedic.co/blog on merge (GitHub Pages)
            - **Email notification** sent via Follow.it when RSS updates (~30 min after merge)

            ---

            ### üîó Preview

            After merging, post will be live at:
            `https://sleepmedic.co/blog/posts/${{ steps.generate.outputs.filename }}`

          branch: blog-draft-${{ github.run_number }}
          base: main
          labels: blog, auto-generated
          assignees: jadenschwartz22-ops
          delete-branch: true

      - name: Create cover image selection issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const title = '${{ steps.generate.outputs.title }}';
            const filename = '${{ steps.generate.outputs.filename }}';
            const topic = '${{ steps.generate.outputs.topic }}';
            const excerpt = `${{ steps.generate.outputs.excerpt }}`;
            const prNumber = '${{ steps.pr.outputs.pull-request-number }}';
            const imageOptions = JSON.parse(fs.readFileSync('tmp/image-options.json', 'utf8'));

            const branchName = '${{ steps.pr.outputs.pull-request-head-sha }}' ? 'blog-draft-${{ github.run_number }}' : 'main';

            let body = `## Select Cover Image for: ${title}\n\n`;
            body += `**Topic:** ${topic}\n\n`;
            body += `### Quick Actions\n\n`;
            body += `- üìù [Edit Post Text](https://github.com/${{ github.repository }}/edit/blog-draft-${{ github.run_number }}/blog/posts/${filename})\n`;
            body += `- üëÄ [Read Full Post](https://github.com/${{ github.repository }}/pull/${prNumber}/files)\n`;
            body += `- üîó [View PR #${prNumber}](https://github.com/${{ github.repository }}/pull/${prNumber})\n\n`;
            body += `### Blog Post Preview\n\n`;
            body += `${excerpt}\n\n`;
            body += `---\n\n`;
            body += `### Choose Your Cover Image\n\n`;
            body += `Comment \`use image [1-5]\` to select and publish.\n\n`;

            imageOptions.forEach((img, i) => {
              body += `#### Image ${i + 1}:\n`;
              body += `![Image ${i + 1}](${img.urls.small})\n`;
              body += `by [${img.user.name}](${img.user.links.html}) on [Unsplash](${img.links.html})\n`;
              body += `[Download: ${img.urls.download}]\n\n`;
            });

            body += `---\n\n`;
            body += `‚è∞ If no selection is made within 24 hours, a random image will be selected automatically.`;

            const resp = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Select Cover Image: ${title}`,
              body,
              assignees: ['jadenschwartz22-ops'],
              labels: ['select-cover-image', 'blog']
            });

            core.info(`Created image selection issue #${resp.data.number}`);

      - name: Cleanup
        if: always()
        run: |
          rm -rf tmp/
          echo "‚úÖ Cleanup complete"
