name: Weekly SleepMedic Blog Draft

on:
  schedule:
    # Every Monday at 9:00 AM Mountain Time (16:00 UTC)
    - cron: "0 16 * * 1"
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  generate-draft:
    runs-on: ubuntu-latest
    env:
      TZ: America/Denver
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      OPENAI_MODEL: gpt-4o-mini

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Generate blog post
        id: generate
        run: |
          node scripts/generate-blog-post.mjs

          TITLE=$(jq -r '.title' tmp/post-metadata.json)
          FILENAME=$(jq -r '.filename' tmp/post-metadata.json)
          TOPIC=$(jq -r '.topic' tmp/post-metadata.json)
          TAG=$(jq -r '.tag' tmp/post-metadata.json)
          IMAGE_IDEA=$(jq -r '.imageIdea' tmp/post-metadata.json | tr '\n' ' ')

          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "filename=$FILENAME" >> $GITHUB_OUTPUT
          echo "topic=$TOPIC" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "image_idea=$IMAGE_IDEA" >> $GITHUB_OUTPUT

      - name: Generate RSS feed
        run: |
          echo "üì° Generating RSS feed..."
          node scripts/generate-rss-feed.mjs
          echo "‚úÖ RSS feed updated"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "blog: Add ${{ steps.generate.outputs.filename }}"
          title: "üìù Blog Draft: ${{ steps.generate.outputs.title }}"
          body: |
            ## ü§ñ Auto-Generated Blog Post

            **Topic:** ${{ steps.generate.outputs.topic }}
            **Tag:** ${{ steps.generate.outputs.tag }}
            **Title:** ${{ steps.generate.outputs.title }}
            **File:** `blog/posts/${{ steps.generate.outputs.filename }}`

            **Cover Image Idea:** ${{ steps.generate.outputs.image_idea }}

            ---

            ### ‚úÖ Review Checklist

            Please review before merging:

            - [ ] **Factual Accuracy** - Verify all sleep science information is correct
            - [ ] **Citations Verify** - Check links to CDC, NIH, AASM, NAMS, etc.
            - [ ] **Tone & Voice** - Matches SleepMedic style (warm, direct, science-forward)
            - [ ] **Links Work** - All inline links resolve correctly
            - [ ] **SEO** - Title, excerpt, and keywords are optimized
            - [ ] **Mobile** - Test responsiveness on mobile device
            - [ ] **Shift Worker Relevance** - Content is practical for target audience

            ---

            ### üìù Notes

            - **Merge within 7 days** to keep content timely
            - **Edit directly in PR** if changes needed (edit files in PR, not branch)
            - **Auto-deploys** to sleepmedic.co/blog on merge (GitHub Pages)
            - **Email notification** sent via Follow.it when RSS updates (~30 min after merge)

            ---

            ### üîó Preview

            After merging, post will be live at:
            `https://sleepmedic.co/blog/posts/${{ steps.generate.outputs.filename }}`

          branch: blog-draft-${{ github.run_number }}
          base: main
          labels: blog, auto-generated
          assignees: jadenschwartz22-ops
          delete-branch: true

      - name: Create notification issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const title = '${{ steps.generate.outputs.title }}';
            const filename = '${{ steps.generate.outputs.filename }}';
            const topic = '${{ steps.generate.outputs.topic }}';

            const issueTitle = `Draft Ready: ${title}`;
            const body = `Your weekly SleepMedic blog draft is ready for review!

            **Topic:** ${topic}
            **File:** \`blog/posts/${filename}\`

            üìã **Action Required:** Review the pull request and merge when ready.

            The post will automatically deploy to sleepmedic.co/blog and trigger email notifications via Follow.it.`;

            const resp = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle.slice(0, 255),
              body,
              assignees: ['jadenschwartz22-ops'],
              labels: ['weekly-draft', 'blog']
            });

            core.info(`Created issue #${resp.data.number}`);

      - name: Cleanup
        if: always()
        run: |
          rm -rf tmp/
          echo "‚úÖ Cleanup complete"
