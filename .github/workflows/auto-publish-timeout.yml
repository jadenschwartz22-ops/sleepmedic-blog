name: Auto-Publish Blog Post (Timeout)

on:
  schedule:
    # Every 6 hours to catch old issues quickly
    - cron: "0 */6 * * *"
  workflow_dispatch: {}
  # Temporary: also run on push to catch waiting issues
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  auto-publish:
    runs-on: ubuntu-latest
    env:
      TZ: America/Denver

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find open image selection issues
        id: find_issues
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'select-cover-image'
            });

            // Filter issues older than 24 hours
            const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
            const oldIssues = issues.filter(issue => {
              return new Date(issue.created_at) < oneDayAgo;
            });

            if (oldIssues.length === 0) {
              core.info('No issues older than 24 hours found');
              core.setOutput('has_issues', 'false');
              return;
            }

            const issue = oldIssues[0]; // Process first old issue
            core.info(`Found old issue #${issue.number}: ${issue.title}`);
            core.setOutput('has_issues', 'true');
            core.setOutput('issue_number', issue.number);
            core.setOutput('issue_body', issue.body);
            core.setOutput('issue_title', issue.title);

      - name: Parse issue and auto-publish
        if: steps.find_issues.outputs.has_issues == 'true'
        id: publish
        env:
          ISSUE_NUMBER: ${{ steps.find_issues.outputs.issue_number }}
          ISSUE_BODY: ${{ steps.find_issues.outputs.issue_body }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          # Random image selection (1-5)
          IMAGE_NUM=$((1 + RANDOM % 5))
          echo "üé≤ Auto-selected random image: #$IMAGE_NUM"
          echo "image_number=$IMAGE_NUM" >> $GITHUB_OUTPUT

          # Extract image URL (format: [Download: URL])
          IMAGE_URL=$(echo "$ISSUE_BODY" | grep -A3 "#### Image $IMAGE_NUM:" | grep "Download:" | sed 's/.*\[Download: \(https:\/\/[^\]]*\)\].*/\1/')

          if [ -z "$IMAGE_URL" ]; then
            echo "‚ùå Could not find download URL for image $IMAGE_NUM"
            exit 1
          fi

          echo "üì• Downloading: $IMAGE_URL"

          # Extract post filename from Edit link
          POST_FILENAME=$(echo "$ISSUE_BODY" | grep "Edit Post Text" | sed 's/.*\/\([^\/]*\.html\).*/\1/')

          if [ -z "$POST_FILENAME" ]; then
            echo "‚ùå Could not find post filename"
            exit 1
          fi

          POST_FILE="blog/posts/$POST_FILENAME"
          echo "üìù Post file: $POST_FILE"
          echo "post_file=$POST_FILE" >> $GITHUB_OUTPUT

          # Extract PR number
          PR_NUM=$(echo "$ISSUE_BODY" | grep -o "View PR #[0-9]*" | sed 's/View PR #//')

          if [ -z "$PR_NUM" ]; then
            echo "‚ùå Could not find PR number"
            exit 1
          fi

          echo "üîó PR #$PR_NUM"
          echo "pr_number=$PR_NUM" >> $GITHUB_OUTPUT

          # Get PR branch
          BRANCH_NAME=$(gh pr view "$PR_NUM" --json headRefName -q .headRefName)
          echo "üåø Branch: $BRANCH_NAME"

          # Checkout PR branch
          git fetch origin "$BRANCH_NAME"
          git checkout "$BRANCH_NAME"

          # Extract photographer (format: by [Name])
          PHOTOGRAPHER=$(echo "$ISSUE_BODY" | grep -A3 "#### Image $IMAGE_NUM:" | grep "by \[" | sed 's/.*by \[\([^\]]*\)\].*/\1/')

          # Extract Unsplash URL (format: [Unsplash](URL))
          UNSPLASH_URL=$(echo "$ISSUE_BODY" | grep -A3 "#### Image $IMAGE_NUM:" | grep "Unsplash\](" | sed 's/.*\[Unsplash\](\([^)]*\)).*/\1/')

          echo "üì∏ Photo by: $PHOTOGRAPHER"
          echo "üîó Unsplash: $UNSPLASH_URL"

          # Download image
          curl -L "$IMAGE_URL" -o blog/cover-temp.jpg

          # Move to final location
          POST_SLUG=$(basename "$POST_FILE" .html)
          mkdir -p blog/posts/images
          mv blog/cover-temp.jpg "blog/posts/images/${POST_SLUG}-cover.jpg"

          # Add cover image to post using awk
          awk -v img="images/${POST_SLUG}-cover.jpg" -v photo="$PHOTOGRAPHER" -v url="$UNSPLASH_URL" '
            /<div class="post-content">/ && !done {
              print "      <div style=\"margin-bottom: 40px;\">"
              print "        <img src=\"" img "\" alt=\"Cover image\" style=\"width: 100%; max-height: 400px; object-fit: cover; border-radius: 24px;\">"
              print "        <p style=\"text-align: center; font-size: 0.85rem; color: var(--muted); margin-top: 8px;\">Photo by <a href=\"" url "\" style=\"color: var(--periwinkle);\">" photo "</a> on Unsplash</p>"
              print "      </div>"
              done=1
            }
            { print }
          ' "$POST_FILE" > /tmp/post-updated.html
          mv /tmp/post-updated.html "$POST_FILE"

          echo "‚úÖ Cover image added to post"

          # Commit changes
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Auto-publish: Add cover image #$IMAGE_NUM (timeout after 24h)"

          # Sync with main and push
          git fetch origin main
          git rebase origin/main || {
            echo "Rebase conflict, trying merge instead"
            git rebase --abort
            git merge origin/main -m "Merge main into branch before auto-publish"
          }

          git push --force-with-lease origin "$BRANCH_NAME"

          # Merge PR (without --auto flag)
          gh pr merge "$PR_NUM" --squash --body "Auto-merged after 24h timeout"

          echo "‚úÖ PR merged successfully"

      - name: Close issue with success message
        if: steps.find_issues.outputs.has_issues == 'true' && steps.publish.outcome == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.find_issues.outputs.issue_number }},
              body: '‚è∞ **Auto-Published (24h Timeout)**\n\nNo image selection received within 24 hours.\n\nRandomly selected image #${{ steps.publish.outputs.image_number }} and published your blog post! üéâ\n\nYour blog post is now live at: https://sleepmedic.co/blog/'
            });

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.find_issues.outputs.issue_number }},
              state: 'closed'
            });

      - name: Cleanup on failure
        if: failure() && steps.find_issues.outputs.has_issues == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.find_issues.outputs.issue_number }},
              body: '‚ùå **Auto-Publish Failed**\n\nThere was an error auto-publishing this post. Please select an image manually or check the workflow logs.\n\n[View workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})'
            });
